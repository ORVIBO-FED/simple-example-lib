<!DOCTYPE>
<html>
<head>
    <title>è‡ªæ—‹é”</title>
</head>

<body>
ğŸ˜‚
<script>
  function getData() {
    return new Promise((resolve, reject) => {
      const xmlhttp = new XMLHttpRequest();
      xmlhttp.open("GET", "http://wthrcdn.etouch.cn/weather_mini?city=æ·±åœ³");
      xmlhttp.onreadystatechange = function () {
        const {readyState, status} = xmlhttp;
        if (readyState === 4 && status === 200) { // æˆåŠŸå®Œæˆ
          return resolve(xmlhttp.responseText)
        }
      }
      xmlhttp.send();
    })
  }

  function sleep() {
    let i = 1000;
    while (i--) ;
  }

  /**
   * è¿ç»­ä»»åŠ¡å¼
   * @returns {string}
   */
  function timerLock() {
    let lock = true;

    // å®šæ—¶è§£é”
    setTimeout(function () {
      lock = false
      console.log('unlock');
    }, 5000)
    const foo = () => setTimeout(function () {
      console.log("æ‰§è¡Œ");
      sleep()
      lock && foo()
    })
    foo();
  }

  //timerLock();

  /**
   * é€’å½’ï¼šæ— æ³•å®ç°ï¼Œä¸æ˜¯ä¸€ä¸ªçº¿ç¨‹ä¸Šçš„ä¸œè¥¿
   */
  function loop() {
    let weather = undefined;
    //å¼‚æ­¥è¯·æ±‚ï¼Œ
    getData().then(res => {
      weather = res;
    });
    (function iterator(i) {
      if (i == 5000 || weather) {
        //to do something.
        console.log("é€’å½’ç»“æŸ", i, weather);
        return;
      }
      sleep();
      iterator(i + 1);
    })(0);

    return weather;
  }

  const res = loop();
  console.log("è¯·æ±‚ç»“æœ" + res);
</script>
</body>
</html>
