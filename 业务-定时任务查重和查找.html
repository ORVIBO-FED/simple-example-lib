<!DOCTYPE>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>åˆ›å»ºæ—¥å†</title>
</head>

<body>
ğŸ˜‚ï¼šè¯·æ‰“å¼€ console æŸ¥çœ‹
<script src="https://unpkg.com/dayjs"></script>
<script>
  //æ’åºå‡½æ•°ï¼Œé…åˆ Array.prototype.sort ä½¿ç”¨
  function compare(property) {
    return function (obj1, obj2) {
      var value1 = obj1[property];
      var value2 = obj2[property];
      return value1 > value2 ? 1 : -1; // å‡åº
    }
  }

  // å¦‚æœæ˜ŸæœŸæ˜¯["Mon", "Tue"]è¿™æ ·çš„è‹±æ–‡æ•°ç»„å½¢å¼ï¼Œåˆ™å…ˆè½¬æ¢æˆæ•°å­—çš„æ•°ç»„
  function wkEn2Num(wk) {
    const wk_en = ["Mon", "Tue", "Wed", "Thur", "Fri", "Sat", "Sun"];
    if (wk.length && !parseInt(wk.join(""))) {
      const wk_num = [];
      wk_en.forEach((item, index) => {
        if (wk.indexOf(item) > -1)
          wk_num.push(index + 1);
      });
      return wk_num;
    }
    return wk;
  }

  /**
   * åŸºäºå½“å‰ï¼Œç”Ÿæˆæœªæ¥8å¤©çš„æ—¶é—´è¡¨
   * @return {Array}
   */
  function create8DayList(ts = undefined) {
    const cur = dayjs(ts);

    // å»ºç«‹æœªæ¥8å¤©çš„è¡¨
    //è¿‡æ»¤å‡ºæ—¶é—´æœ‰æ•ˆçš„ï¼Œå³æœªæ¥çš„
    return Array.from({length: 8}).map((item, index) => {
      const date = cur.add(index, "day");
      let day = date.day();
      if (day === 0) day = 7;
      return {
        day,
        date: date.format("YYYY/MM/DD"),
        time: [],
      };
    })
  }

  /**
   * æ¯”è¾ƒæ–°å»ºä»»åŠ¡å®šæ—¶æ˜¯å¦åœ¨åˆ—è¡¨ä¸­
   * @param allMsList æ‰€æœ‰ä»»åŠ¡åˆ—è¡¨
   * @param mission å½“å‰ä»»åŠ¡
   * @param ts åŸºäºçš„æ—¶é—´æˆ³ï¼Œå¯ä»¥ä¸ä¼ ï¼ˆä¸ºå½“å‰ï¼‰
   * @returns {boolean}
   */
  function checkIfTimeOverlap(allMsList, mission, ts = undefined) {
    const cur = dayjs(ts);
    const curTs = cur.valueOf();
    const curDate = cur.format("YYYY/MM/DD");
    const tmrDate = cur.add(1, "day").format("YYYY/MM/DD");

    // å¤åˆ¶ä¸€ä»½æ“ä½œ
    let _mission = JSON.parse(JSON.stringify(mission));
    let _allMsList = JSON.parse(JSON.stringify(allMsList));

    _mission.week = wkEn2Num(_mission.week);
    _allMsList.forEach(item => {
      item.week = wkEn2Num(item.week)
    });

    // æ ¡éªŒ
    if (_allMsList.some(item => !Array.isArray(item.week) || !item.time.match(/^\d{2}\:\d{2}$/))) {
      console.error("å‚æ•°1æ•°ç»„é”™è¯¯ï¼Œå…ƒç´ å¿…é¡»è¦æœ‰ week å’Œ time ä¸¤ä¸ªå±æ€§ï¼Œä¸”å¿…é¡»æ˜¯æ•°ç»„å’Œæ—¶é—´å­—ç¬¦ä¸²ã€‚å‚æ•°1ï¼š\n", _allMsList);
      return false;
    }
    if (typeof _mission !== "object" || !_mission.time || !_mission.week) {
      console.error("å‚æ•°2å¯¹è±¡é”™è¯¯ï¼Œå¯¹è±¡å¿…é¡»è¦æœ‰ week å’Œ time ä¸¤ä¸ªå±æ€§ï¼Œä¸”å¿…é¡»æ˜¯æ•°ç»„å’Œæ—¶é—´å­—ç¬¦ä¸²ã€‚å‚æ•°2ï¼š\n", _mission);
      return false;
    }

    // æ‰€æœ‰ä»»åŠ¡ç”Ÿæˆæ—¥å†
    const calendar = create8DayList(ts);
    calendar.forEach(calendarItem => {
      _allMsList.forEach(allItem => {
        //å•æ¬¡çš„ä»»åŠ¡ï¼šå…ˆèµ‹äºˆå…¶æ˜ŸæœŸ
        if (!allItem.week.length) {
          const todayMsTs = dayjs(curDate + " " + allItem.time).valueOf();
          const tmrMsTs = dayjs(tmrDate + " " + allItem.time).valueOf();

          const missionTs = todayMsTs > curTs
            ? todayMsTs
            : tmrMsTs;

          allItem.week.push(dayjs(missionTs).day());
        }
        // æ—¶é—´é›†ä¸­åˆ°dayä¸­
        if (allItem.week.find(item => item === calendarItem.day)) {
          calendarItem.time.push(allItem.time);
        }
      })
    });

    // å•æ¬¡å®šæ—¶æ‰¾å‡ºå…¶ week
    if (_mission.week.length === 0) {
      // å¦‚æœæ—¶é—´è¿‡å»äº†ï¼Œé‚£å°±æ˜¯æ˜å¤©çš„ä»»åŠ¡ï¼Œæœªè¿‡å»å°±æ˜¯ä»Šå¤©çš„ä»»åŠ¡
      const todayMsTs = dayjs(curDate + " " + _mission.time).valueOf();
      const tmrMsTs = dayjs(tmrDate + " " + _mission.time).valueOf();

      const missionTs = todayMsTs > curTs
        ? todayMsTs
        : tmrMsTs;

      _mission.week.push(dayjs(missionTs).day());
    }

    // åœ¨æ—¥å†ä¸­æ¯”è¾ƒ
    return calendar.some(item => {
      if (_mission.week.find(day => day === item.day)) {
        return item.time.indexOf(_mission.time) > -1;
      }
    });
  }

  /**
   * æ‰¾å‡ºæœ€è¿‘è¦æ‰§è¡Œçš„ä»»åŠ¡çš„index
   * @param allMsList æ‰€æœ‰ä»»åŠ¡åˆ—è¡¨
   * @param ts åŸºäºçš„æ—¶é—´æˆ³ï¼Œå¯ä»¥ä¸ä¼ ï¼ˆä¸ºå½“å‰ï¼‰
   * @returns {Number} æœ€è¿‘ä»»åŠ¡çš„åºå·
   */
  function findLatestMission(allMsList, ts = undefined) {
    const cur = dayjs(ts);
    const curDate = cur.format("YYYY/MM/DD");
    const tmrDate = cur.add(1, "day").format("YYYY/MM/DD");
    const curTs = cur.valueOf();

    // å¤åˆ¶ä¸€ä»½æ“ä½œ
    let _allMsList = JSON.parse(JSON.stringify(allMsList));
    _allMsList.forEach(item => {
      item.week = wkEn2Num(item.week)
    });

    // æ‰€æœ‰ä»»åŠ¡ç”Ÿæˆæ—¥å†ï¼Œå¹¶å¾—åˆ°æ—¶é—´æˆ³
    const calendar = create8DayList(ts);
    let calendarTsList = [];
    calendar.forEach(calendarItem => {
      _allMsList.forEach((allItem, index) => {
        //å•æ¬¡çš„ä»»åŠ¡ï¼šå…ˆèµ‹äºˆå…¶æ˜ŸæœŸ
        if (!allItem.week.length) {
          const todayMsTs = dayjs(curDate + " " + allItem.time).valueOf();
          const tmrMsTs = dayjs(tmrDate + " " + allItem.time).valueOf();

          const missionTs = todayMsTs > curTs
            ? todayMsTs
            : tmrMsTs;

          allItem.week.push(dayjs(missionTs).day());
        }
        // æ—¶é—´é›†ä¸­åˆ°dayä¸­
        if (allItem.week.find(item => item === calendarItem.day)) {
          calendarItem.time.push(allItem.time);
          const ts = dayjs(`${calendarItem.date} ${allItem.time}`).valueOf();
          // ç»“æœçš„å½¢å¼
          calendarTsList.push({
            timestamp: ts,
            index,
            date: dayjs(ts).format("YYYY-MM-DD"),
            time: dayjs(ts).format("HH:mm"),
          });
        }
      });
    });

    // æ‰€æœ‰ä»»åŠ¡æŸ¥çœ‹
/*    calendar.forEach(item => {
      console.log("æ˜ŸæœŸ" + item.day, item.time);
    });*/

    // æ’åº
    calendarTsList = calendarTsList.sort(compare("timestamp"));

    // æ‰¾å‡ºæ—¶é—´æˆ³æœ€æ¥è¿‘çš„æ—¶é—´æˆ³
    let res = undefined;
    for (let i = 0; i < calendarTsList.length; i++) {
      const item = calendarTsList[i];
      if (curTs < item.timestamp) {
        res = item;
        break;
      }
    }

    // æ‰¾ä¸åˆ°å°±æ˜¯ undefined
    return res;
  }

  /* ----------------------------------------- æµ‹è¯• ----------------------------------------- */

  const TIME = "2019-05-21 11:00:20"; // æ­¤æ—¶é—´ä¸ºæ˜ŸæœŸ2
  console.info(`æµ‹è¯•æ—¶é—´ï¼š${TIME}ï¼Œæ˜ŸæœŸ${dayjs(TIME).day()}`);
  const ts = dayjs(TIME).valueOf();
  const allMsList = [
    {week: [1, 2, 3, 4, 5, 6, 7], time: "00:00"},
    {week: ["Mon", "Tue", "Wed", "Thur", "Fri", "Sat", "Sun"], time: "12:00"},
    {week: [5, 6, 7], time: "12:00"},
    {week: [1, 2, 3], time: "10:00"},
    {week: [3, 4], time: "01:00"},
    {week: [5, 6], time: "00:10"},
    {week: [3], time: "00:01"},
    {week: [7], time: "12:00"},
    {week: [1], time: "00:01"},
    {week: [], time: "11:11"},
    {week: [], time: "22:22"},
  ];
  //const allMsList = [];
  console.log("å…¨ä»»åŠ¡åˆ—è¡¨", allMsList);

  const missionList = [
    // å•æ¬¡
    {time: "09:00", week: [], except: false},
    {time: "10:00", week: [], except: true},
    {time: "12:00", week: [], except: true},
    {time: "12:01", week: [], except: false},
    {time: "00:01", week: [], except: true},
    {time: "01:00", week: [], except: true},
    {time: "13:00", week: [], except: false},
    {time: "11:11", week: [], except: true},
    // å¤šæ¬¡
    {time: "13:00", week: [1, 2, 3], except: false},
    {time: "12:00", week: ["Mon", "Tue", "Wed"], except: true},
    {time: "12:00", week: [6], except: true},
    {time: "12:01", week: [1, 2, 3], except: false},
    {time: "10:00", week: [3], except: true},
    {time: "10:00", week: [4], except: false},
  ];


  // ä»»åŠ¡æŸ¥é‡
  console.group("æ£€æŸ¥ä»»åŠ¡æ˜¯å¦åœ¨åˆ—è¡¨ä¸­ï¼š");
  console.log(`åŸºäºæ—¶é—´ï¼š${TIME}ï¼ŒæœŸå¾…å¿…é¡»å…¨éƒ¨ä¸º true`);
  missionList.forEach(item => {
    const res = checkIfTimeOverlap(allMsList, item, ts);
    console.log(`ç¬¦åˆæœŸå¾…ï¼š${res === item.except ? "âœ”ï¸" : "âŒ"}ï¼Œåœ¨é¢„è®¾ä»»åŠ¡åˆ—è¡¨ä¸­ï¼š${res}ï¼Œ${JSON.stringify(item)}`);
  });
  console.groupEnd();

  // æœ€æ–°ä»»åŠ¡
  console.group("æ‰¾åˆ°æœ€è¿‘è¦è¿è¡Œçš„ä»»åŠ¡");
  const timeList = [
    {time: "2019-05-21 11:00", except: "11:11"},
    {time: "2019-05-21 00:00:20", except: "10:00"},
    {time: "2019-05-21 00:12:20", except: "10:00"},
    {time: "2019-05-21 00:10", except: "10:00"},
    {time: "2019-05-22 12:00:20", except: "22:22"},
    {time: "2019-05-22 20:00:20", except: "22:22"},
    {time: "2019-05-22 23:55:20", except: "00:00"},
  ];
  timeList.forEach(item => {
    const mission = findLatestMission(allMsList, dayjs(item.time).valueOf());
    const {date, time} = mission;
    console.log(`ç¬¦åˆæœŸå¾…ï¼š${time === item.except ? "âœ”ï¸" : "âŒ"}ï¼Œæœ€è¿‘${item.time}çš„ä»»åŠ¡æ—¶é—´ï¼š${date + " " + time}`);
  });
  console.groupEnd();
</script>
</body>
</html>
