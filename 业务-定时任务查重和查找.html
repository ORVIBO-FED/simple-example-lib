<!DOCTYPE>
<html>
<head>
    <title>创建日历</title>
</head>

<body>
😂：console 查看
<script src="https://unpkg.com/dayjs"></script>
<script>
  /**
   * 基于当前，生成未来8天的时间表
   * @return {Array}
   */
  function createEightDayList(timestamp) {
    const current = dayjs(timestamp || "");

    // 建立未来8天的表
    //过滤出时间有效的，即未来的
    return Array.from({length: 8}).map((item, index) => {
      const date = current.add(index, "day");
      let day = date.day();
      if (day === 0) day = 7;
      return {
        day,
        date: date.format("YYYY/MM/DD"),
        time: [],
      };
    })
  }

  /**
   * 比较新建任务定时是否在列表中
   * @param allWeekAndTime
   * @param missionWeekAndTime
   */
  function checkIfTimeOverlap(timestamp, allWeekAndTime, missionWeekAndTime) {
    const current = dayjs(timestamp || "");
    const currentTimestamp = current.valueOf();
    const currentDate = current.format("YYYY/MM/DD");
    const currentTime = current.format("hh:mm:ss");
    const _missionWeekAndTime = JSON.parse(JSON.stringify(missionWeekAndTime));

    // 校验
    if (allWeekAndTime.some(item => !Array.isArray(item.week) || !item.time.match(/^\d{2}\:\d{2}$/))) {
      console.error("参数1数组错误，元素必须要有 week 和 time 两个属性，且必须是数组和时间字符串。参数1：\n", allWeekAndTime);
      return;
    }
    if (typeof _missionWeekAndTime !== "object" || !_missionWeekAndTime.time || !_missionWeekAndTime.week) {
      console.error("参数2对象错误，对象必须要有 week 和 time 两个属性，且必须是数组和时间字符串。参数2：\n", _missionWeekAndTime)
    }

    // 所有任务生成日历
    const calender = createEightDayList(timestamp);
    calender.forEach(calenderItem => {
      allWeekAndTime.forEach(arrItem => {
        // 时间集中到day中
        if (arrItem.week.find(item => item === calenderItem.day)) {
          calenderItem.time.push(arrItem.time);
        }
      })
    });

    // 单次定时
    if (_missionWeekAndTime.week.length === 0) {
      // 如果时间过去了，那就是明天的任务，未过去就是今天的任务
      const todayMissionTimestamp = dayjs(currentDate + " " + _missionWeekAndTime.time).valueOf();
      const tomorrowMissionTimestamp = dayjs(
        current.add(1, "day").format("YYYY/MM/DD") + " " + _missionWeekAndTime.time
      ).valueOf();

      const missionTimestamp = todayMissionTimestamp > currentTimestamp
        ? todayMissionTimestamp
        : tomorrowMissionTimestamp;

      _missionWeekAndTime.week.push(dayjs(missionTimestamp).day());
    }

    // 在日历中比较
    return calender.some(item => {
      if (_missionWeekAndTime.week.find(day => day === item.day)) {
        return item.time.indexOf(_missionWeekAndTime.time) > -1;
      }
    });
  }

  // 测试
  const TIME = "2019-05-21T11:00:20+08:00"; // 此时间为星期2
  const allWeekAndTime = [
    {week: [1, 2, 3, 4, 5, 6, 7], time: "00:00"},
    {week: [1, 2, 3, 4, 5, 6, 7], time: "12:00"},
    {week: [5, 6, 7], time: "12:00"},
    {week: [1, 2, 3], time: "10:00"},
    {week: [3, 4], time: "01:00"},
    {week: [5, 6], time: "00:10"},
    {week: [3], time: "00:01"},
    {week: [7], time: "12:00"},
    {week: [1], time: "00:01"},
    {week: [], time: "11:11"},
  ];

  //const allWeekAndTime = [];

  const missionList = [
    // 单次
    {time: "09:00", week: [], except: false},
    {time: "10:00", week: [], except: true},
    {time: "12:00", week: [], except: true},
    {time: "12:01", week: [], except: false},
    {time: "00:01", week: [], except: true},
    {time: "01:00", week: [], except: true},
    {time: "13:00", week: [], except: false},
    // 多次
    {time: "13:00", week: [1, 2, 3], except: false},
    {time: "12:00", week: [1, 2, 3], except: true},
    {time: "12:00", week: [6], except: true},
    {time: "12:01", week: [1, 2, 3], except: false},
    {time: "10:00", week: [3], except: true},
    {time: "10:00", week: [4], except: false},
  ];
  console.log(`基于时间：${TIME}，期待必须全部为 true`);
  allWeekAndTime.forEach(item => {
    console.log("预设任务：", JSON.stringify(item));
  })
  missionList.forEach(item => {
    const res = checkIfTimeOverlap(dayjs(TIME).valueOf(), allWeekAndTime, item);
    console.log(`时间：${item.time}，星期：${item.week}，是否存在于预设任务列表中：${res}，是否符合期待：${res === item.except}`);
  })
</script>
</body>
</html>
